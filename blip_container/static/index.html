<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BLIP Image Captioning Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
      }
      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
      }
      .upload-area:hover {
        border-color: #666;
      }
      .preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
      }
      .image-container {
        position: relative;
        width: 200px;
      }
      .image-container img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 4px;
      }
      .caption {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px;
        border-radius: 4px;
        margin-top: 5px;
        font-size: 14px;
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .error {
        color: red;
        text-align: center;
        margin: 10px 0;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: block;
        margin: 20px auto;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>BLIP Image Captioning Test</h1>

      <div class="upload-area" id="dropZone">
        <p>Drag and drop images here or click to select files</p>
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*"
          style="display: none"
        />
      </div>

      <div class="loading" id="loading">
        <p>Generating captions...</p>
      </div>

      <div class="error" id="error"></div>

      <button id="generateBtn" disabled>Generate Captions</button>

      <div class="preview" id="preview"></div>
    </div>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const generateBtn = document.getElementById("generateBtn");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");

      let selectedFiles = [];

      // Handle drag and drop
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#4CAF50";
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.style.borderColor = "#ccc";
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#ccc";
        const files = Array.from(e.dataTransfer.files).filter((file) =>
          file.type.startsWith("image/")
        );
        handleFiles(files);
      });

      // Handle click to upload
      dropZone.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
      });

      function handleFiles(files) {
        selectedFiles = files;
        preview.innerHTML = "";
        error.textContent = "";

        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const div = document.createElement("div");
            div.className = "image-container";
            div.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="caption">Waiting for caption...</div>
                    `;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });

        generateBtn.disabled = false;
      }

      generateBtn.addEventListener("click", async () => {
        loading.style.display = "block";
        error.textContent = "";
        generateBtn.disabled = true;

        try {
          const formData = new FormData();
          selectedFiles.forEach((file) => {
            formData.append("files", file);
          });

          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error("Upload failed");
          }

          const data = await response.json();

          // Update captions
          const captions = document.querySelectorAll(".caption");
          data.results.forEach((result, index) => {
            if (captions[index]) {
              captions[index].textContent = result.caption;
            }
          });
        } catch (err) {
          error.textContent = "Error: " + err.message;
        } finally {
          loading.style.display = "none";
          generateBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
